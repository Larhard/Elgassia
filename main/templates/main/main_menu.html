{% load main.menus %}

<script type="text/javascript">
    function main_menu_save() {
        var main_menu_list = $("#main_menu_list");
        var idx = [];
        var title = [];
        var dest_name = [];
        var dest_url = [];
        var dest_page = [];
        var remove = [];
        main_menu_list.find("input[name*='idx']").each(function() {
            idx.push($(this).val());
        });
        main_menu_list.find("input[name*='title']").each(function() {
            title.push($(this).val());
        });
        main_menu_list.find("input[name*='dest_page']").each(function() {
            dest_page.push($(this).val());
        });
        main_menu_list.find("input[name*='dest_name']").each(function() {
            dest_name.push($(this).val());
        });
        main_menu_list.find("input[name*='dest_url']").each(function() {
            dest_url.push($(this).val());
        });
        main_menu_list.find("input[name*='remove']").each(function() {
            remove.push($(this).prop("checked"));
        });

        submit_and_redirect($(this).attr("data-url"),
                {
                    'idx[]': idx,
                    'title[]': title,
                    'dest_page[]': dest_page,
                    'dest_name[]': dest_name,
                    'dest_url[]': dest_url,
                    'remove[]': remove
                });
    }

    function main_menu_add_entry() {
        $("#main_menu_list").append(
                        '<li>' +
                        '    <div class="main_menu_entry editable main_menu_entry_edit toggleable_containter">' +
                        '        <ul class="clean">' +
                        '            <li><label>title:<br><input name="title" type="text"></label></li>' +
                        '            <li class="toggleable"><label>dest_page: <input name="dest_page" type="text"></label></li>' +
                        '            <li class="toggleable"><label>dest_name: <input name="dest_name" type="text"></label></li>' +
                        '            <li class="toggleable"><label>dest_url: <input name="dest_url" type="text"></label></li>' +
                        '            <li class="toggleable"><label>remove: <input type="checkbox" name="removed"></label></li>' +
                        '            <input type="hidden" name="idx" value="-1">' +
                        '            <li><div class="align_right"><button class="toggle_button">more</button></div></li>' +
                        '        </ul>' +
                        '    </div>' +
                        '</li>'
        );
    }

    $(document).on("click", "#main_menu_save_button", main_menu_save);
    $(document).on("click", "#main_menu_add_entry_button", main_menu_add_entry);
</script>

{% get_main_menu %}
{% for i in main_menu %}
    <li>
        {% if i.dest_page %}
            {% url 'main:page' i.dest_page as u %}
            <a class="block main_menu_entry toggleable" href="{{ u }}">
                {{ i.title }}
            </a>
        {% elif i.dest_name %}
            {% url i.dest_name as u %}
            <a class="block main_menu_entry toggleable" href="{{ u }}">
                {{ i.title }}
            </a>
        {% elif i.dest_url %}
            <a class="block main_menu_entry toggleable" href="{{ i.dest_url }}">
                {{ i.title }}
            </a>
        {% else %}
            <div class="main_menu_entry toggleable">
                {{ i.title }}
            </div>
        {% endif %}

        {% if user.is_staff %}
            <div class="main_menu_entry toggleable toggleable_container hidden main_menu_entry_edit">
                <ul class="clean">
                    <li><label>title:<br><input name="title" type="text" value="{{ i.title }}"></label></li>
                    <li class="toggleable hidden"><label>dest_page: <input name="dest_page" type="text" value="{{ i.dest_page }}"></label></li>
                    <li class="toggleable hidden"><label>dest_name: <input name="dest_name" type="text" value="{{ i.dest_name }}"></label></li>
                    <li class="toggleable hidden"><label>dest_url: <input name="dest_url" type="text" value="{{ i.dest_url }}"></label></li>
                    <li class="toggleable hidden"><label>remove: <input type="checkbox" name="remove"></label></li>
                    <input type="hidden" name="idx" value="{{ i.id }}">
                    <li><div class="align_right"><button class="toggle_button">more</button></div></li>
                </ul>
            </div>
        {% endif %}
    </li>
{% endfor %}
